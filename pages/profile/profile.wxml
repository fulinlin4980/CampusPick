<!-- pages/profile/profile.wxml -->

<view class="container">

<!-- æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•è¡¨å• -->
<block wx:if="{{!isLoggedIn}}">
    <view class="login-card">
        <view class="login-title">æ¬¢è¿ç™»å½•</view>
        <view class="input-area">
            <view class="input-group">
                <text class="label">è´¦å·</text>
                <!-- ç»‘å®š handleInput -->
                <input class="input-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" data-field="username" bindinput="handleInput" value="{{username}}" />
            </view>
            <view class="input-group">
                <text class="label">å¯†ç </text>
                <!-- ç»‘å®š handleInput -->
                <input class="input-control" placeholder="è¯·è¾“å…¥å¯†ç " password type="text" data-field="password" bindinput="handleInput" value="{{password}}" />
            </view>
        </view>
        
        <!-- ç»‘å®š handleLogin -->
        <button class="login-btn" bindtap="handleLogin">
            ç«‹å³ç™»å½•
        </button>
        <view class="register-link" bindtap="goToRegister">
            æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ
        </view>
    </view>
</block>

<!-- ç™»å½•çŠ¶æ€ï¼šç¾è§‚çš„ä¸ªäººä¿¡æ¯å±•ç¤º -->
<block wx:else>
    <!-- å¤´éƒ¨ç”¨æˆ·å¡ç‰‡ï¼šæ¸å˜èƒŒæ™¯è®¾è®¡ -->
    <view class="profile-header-card">
        <view class="user-info">
            <!-- æ¨¡æ‹Ÿå¤´åƒåŒºåŸŸ -->
            <view class="avatar">
                <!-- ä½¿ç”¨ç®€å•çš„ emoji æˆ–å›¾æ ‡ä½œä¸ºå ä½ç¬¦ -->
                <text class="iconfont icon-user">ğŸ‘¤</text>
            </view>
            <view class="details">
                <view class="username">{{currentUser.username || 'æ ¡å›­è·‘è…¿ç”¨æˆ·'}}</view>
                <view class="status">âœ… å·²è®¤è¯å­¦ç”Ÿ | ID: {{userId}}</view>
            </view>
        </view>

        <!-- ç»Ÿè®¡æ•°æ®åŒºåŸŸ -->
        <view class="stats-area">
            <view class="stat-item">
                <view class="stat-value">{{currentUser.score || '85'}}</view>
                <view class="stat-label">ä¿¡èª‰ç§¯åˆ†</view>
            </view>
            <view class="stat-divider"></view>
            <!-- è®¢å•æ•°é‡ç»Ÿè®¡ï¼ˆç‚¹å‡»å¯åˆ‡æ¢Tabï¼‰ -->
            <view class="stat-item" bindtap="handleTabChange" data-tab="published">
                <view class="stat-value">{{publishedCount}}</view>
                <view class="stat-label">å·²å‘å¸ƒè®¢å•</view>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item" bindtap="handleTabChange" data-tab="accepted">
                <view class="stat-value">{{acceptedCount}}</view>
                <view class="stat-label">å·²æ¥å—ä»»åŠ¡</view>
            </view>
        </view>
    </view>

    <!-- è®¢å•åˆ—è¡¨ Tab åˆ‡æ¢å¡ç‰‡ -->
    <view class="order-tabs-card">
        <view class="tab-item {{activeTab === 'published' ? 'active-tab' : ''}}" 
              bindtap="handleTabChange" data-tab="published">
            æˆ‘å‘å¸ƒçš„ ({{publishedCount}})
        </view>
        <view class="tab-item {{activeTab === 'accepted' ? 'active-tab' : ''}}" 
              bindtap="handleTabChange" data-tab="accepted">
            æˆ‘æ¥å—çš„ ({{acceptedCount}})
        </view>
    </view>

    <!-- è®¢å•åˆ—è¡¨å±•ç¤º -->
    <view class="order-list">
        <block wx:if="{{displayOrders.length > 0}}">
            <!-- å¾ªç¯å±•ç¤ºè®¢å•åˆ—è¡¨ï¼Œæ¯ä¸ªè®¢å•æ˜¯ä¸€ä¸ªå¡ç‰‡ -->
            <view wx:for="{{displayOrders}}" wx:key="id" class="order-item-card">
                <view class="order-header">
                    <text class="order-type">#{{item.type === 'RUN_TASK' ? 'è·‘è…¿ä»»åŠ¡' : 'å…¶ä»–'}}</text>
                    <!-- è®¢å•çŠ¶æ€ä½¿ç”¨ä¸åŒçš„æ ·å¼ç±» (status-PENDING, status-ACCEPTED ç­‰) -->
                    <text class="order-status status-{{item.status}}">{{item.status}}</text>
                </view>
                <view class="order-body">
                    <view class="description">{{item.description}}</view>
                    <view class="location-info">
                        <text class="pickup">å–: {{item.pickupLocation}}</text>
                        <text class="delivery">é€: {{item.deliveryLocation}}</text>
                    </view>
                    <view class="price-info">
                        <text class="price">ä½£é‡‘: Â¥{{item.price.toFixed(2)}}</text>
                    </view>
                </view>
                <!-- è®¢å•æ“ä½œæŒ‰é’® -->
                <view class="order-actions">
    <button wx:if="{{activeTab === 'published' && item.status === 'PENDING'}}" 
            class="action-btn cancel-btn" data-order-id="{{item.id}}" data-action="cancel" bindtap="handleAction">å–æ¶ˆ</button>
    
    <button wx:if="{{activeTab === 'published' && item.status === 'DELIVERING'}}" 
            class="action-btn complete-btn" data-order-id="{{item.id}}" data-action="settle" bindtap="handleAction">ç»“ç®—</button>

    <button wx:if="{{activeTab === 'accepted' && item.status === 'ACCEPTED'}}" 
            class="action-btn complete-btn" data-order-id="{{item.id}}" data-action="complete" bindtap="handleAction">é€è¾¾</button>
</view>
            </view>
        </block>
        <view wx:else class="empty-state">
            <text>æ‚¨è¿˜æ²¡æœ‰{{activeTab === 'published' ? 'å‘å¸ƒ' : 'æ¥å—'}}ä»»ä½•è®¢å•å“¦~</text>
        </view>
    </view>

    <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
    <button class="logout-btn" bindtap="handleLogout">
        é€€å‡ºç™»å½•
    </button>
</block>


</view>